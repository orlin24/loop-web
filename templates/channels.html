{% extends "layout.html" %}
{% block content %}
<div class="row">
    <!-- OAuth Configuration Section -->
    <div class="col-12 mb-4">
        <div class="card bg-dark border-secondary">
            <div class="card-header bg-secondary bg-opacity-25 d-flex justify-content-between align-items-center">
                <h5 class="mb-0">
                    <i class="bi bi-key text-warning me-2"></i> YouTube OAuth Configuration
                </h5>
                <span id="oauthStatus" class="badge bg-secondary">Checking...</span>
            </div>
            <div class="card-body">
                <p class="text-secondary small mb-3">
                    Enter your Google Cloud OAuth credentials. Get them from
                    <a href="https://console.cloud.google.com/apis/credentials" target="_blank" class="text-info">Google Cloud Console</a>.
                </p>
                <form id="oauthForm">
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label">Client ID</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary"
                                   id="clientId" placeholder="xxxx.apps.googleusercontent.com">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Client Secret</label>
                            <div class="input-group">
                                <input type="password" class="form-control bg-dark text-light border-secondary"
                                       id="clientSecret" placeholder="GOCSPX-xxxxx">
                                <button type="button" class="btn btn-outline-secondary" onclick="toggleSecret()">
                                    <i class="bi bi-eye" id="secretIcon"></i>
                                </button>
                            </div>
                        </div>
                        <div class="col-12">
                            <label class="form-label">Redirect URI</label>
                            <input type="text" class="form-control bg-dark text-light border-secondary"
                                   id="redirectUri" placeholder="https://yourdomain.com/loopbot/oauth2callback">
                            <small class="text-secondary">This must match the redirect URI in your Google Cloud Console.</small>
                        </div>
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary">
                                <i class="bi bi-save me-1"></i> Save OAuth Config
                            </button>
                            <button type="button" class="btn btn-outline-danger ms-2" onclick="deleteOAuthConfig()">
                                <i class="bi bi-trash me-1"></i> Delete
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Header -->
    <div class="col-12 mb-4 d-flex justify-content-between align-items-center">
        <h2>
            <i class="bi bi-youtube text-danger me-2"></i> YouTube Channels
        </h2>
        <a href="/loopbot/auth?mode=add" class="btn btn-primary" id="addChannelBtn">
            <i class="bi bi-plus-lg me-1"></i> Add Channel
        </a>
    </div>

    <!-- Channel List -->
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 align-middle">
                        <thead>
                            <tr class="bg-secondary bg-opacity-10">
                                <th style="width: 80px;">Profile</th>
                                <th>Channel Name</th>
                                <th>Subscribers</th>
                                <th>Total Views</th>
                                <th>Videos</th>
                                <th style="width: 150px;">Status</th>
                                <th style="width: 150px;" class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="channelListBody">
                            <!-- Populated by JS -->
                            <tr id="loadingRow">
                                <td colspan="7" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-secondary mt-2">Loading channels...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Remove Channel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove <strong id="deleteChannelName" class="text-light"></strong>?</p>
                <p class="text-secondary small">This will remove the credentials from LoopBot. You will need to login
                    again to use this channel.</p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Remove</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentChannels = [];
    let deleteId = null;
    let oauthConfigured = false;

    document.addEventListener('DOMContentLoaded', () => {
        loadOAuthConfig();
        loadChannels();

        // OAuth form submit
        document.getElementById('oauthForm').addEventListener('submit', saveOAuthConfig);
    });

    // ===== OAuth Configuration Functions =====
    function loadOAuthConfig() {
        fetch('/loopbot/oauth-config')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    const config = data.config;
                    document.getElementById('clientId').value = config.client_id || '';
                    document.getElementById('clientSecret').value = config.client_secret || '';
                    document.getElementById('redirectUri').value = config.redirect_uri || window.location.origin + '/loopbot/oauth2callback';

                    oauthConfigured = config.configured;
                    updateOAuthStatus(config.configured);
                }
            })
            .catch(err => {
                console.error('Failed to load OAuth config:', err);
                // Set default redirect URI
                document.getElementById('redirectUri').value = window.location.origin + '/loopbot/oauth2callback';
            });
    }

    function updateOAuthStatus(configured) {
        const statusBadge = document.getElementById('oauthStatus');
        const addBtn = document.getElementById('addChannelBtn');

        if (configured) {
            statusBadge.className = 'badge bg-success';
            statusBadge.innerHTML = '<i class="bi bi-check-circle me-1"></i> Configured';
            addBtn.classList.remove('disabled');
            addBtn.removeAttribute('title');
        } else {
            statusBadge.className = 'badge bg-warning text-dark';
            statusBadge.innerHTML = '<i class="bi bi-exclamation-triangle me-1"></i> Not Configured';
            addBtn.classList.add('disabled');
            addBtn.setAttribute('title', 'Configure OAuth first');
        }
    }

    function saveOAuthConfig(e) {
        e.preventDefault();

        const clientId = document.getElementById('clientId').value.trim();
        const clientSecret = document.getElementById('clientSecret').value.trim();
        const redirectUri = document.getElementById('redirectUri').value.trim();

        if (!clientId || !clientSecret) {
            alert('Client ID and Client Secret are required');
            return;
        }

        fetch('/loopbot/oauth-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ client_id: clientId, client_secret: clientSecret, redirect_uri: redirectUri })
        })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                alert('OAuth configuration saved!');
                oauthConfigured = true;
                updateOAuthStatus(true);
            } else {
                alert('Error: ' + data.message);
            }
        })
        .catch(err => alert('Failed to save: ' + err.message));
    }

    function deleteOAuthConfig() {
        if (!confirm('Delete OAuth configuration? You will need to reconfigure to add channels.')) return;

        fetch('/loopbot/oauth-config', { method: 'DELETE' })
        .then(r => r.json())
        .then(data => {
            if (data.success) {
                document.getElementById('clientId').value = '';
                document.getElementById('clientSecret').value = '';
                oauthConfigured = false;
                updateOAuthStatus(false);
                alert('OAuth configuration deleted');
            } else {
                alert('Error: ' + data.message);
            }
        });
    }

    function toggleSecret() {
        const input = document.getElementById('clientSecret');
        const icon = document.getElementById('secretIcon');
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'bi bi-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'bi bi-eye';
        }
    }

    // ===== Channel Functions =====
    function loadChannels() {
        fetch('/loopbot/channels/list')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    currentChannels = data.channels;
                    renderChannels();
                } else {
                    showError(data.message);
                }
            })
            .catch(err => showError(err.message));
    }

    function renderChannels() {
        const tbody = document.getElementById('channelListBody');

        if (currentChannels.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5 text-secondary">
                        <i class="bi bi-person-x fs-1 mb-3 d-block"></i>
                        No channels connected. Click "Add Channel" to connect your YouTube account.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = currentChannels.map(c => `
            <tr class="${c.active ? 'table-active border-start border-primary border-4' : ''}">
                <td>
                    <img src="${c.thumbnail}" alt="Thumb" class="rounded-circle" width="50" height="50">
                </td>
                <td>
                    <div class="fw-bold fs-5">${c.title}</div>
                    <small class="text-secondary text-monospace">${c.id}</small>
                </td>
                <td>${parseInt(c.subscriberCount).toLocaleString()}</td>
                <td>${parseInt(c.viewCount).toLocaleString()}</td>
                <td>${parseInt(c.videoCount).toLocaleString()}</td>
                <td>
                    ${c.active
                ? '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i> Active</span>'
                : `<button class="btn btn-sm btn-outline-primary" onclick="switchChannel('${c.id}')">Switch to this</button>`
            }
                </td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-danger" onclick="promptDelete('${c.id}', '${escapeHtml(c.title)}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function switchChannel(id) {
        if (!confirm('Switch active channel to this one?')) return;

        fetch(`/loopbot/channels/switch/${id}`, { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    // Reload to update UI
                    window.location.reload();
                } else {
                    alert('Failed to switch: ' + d.message);
                }
            });
    }

    function promptDelete(id, name) {
        deleteId = id;
        document.getElementById('deleteChannelName').textContent = name;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    function confirmDelete() {
        if (!deleteId) return;

        fetch(`/loopbot/channels/delete/${deleteId}`, { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    location.reload();
                } else {
                    alert(d.message);
                }
            });
    }

    function showError(msg) {
        document.getElementById('channelListBody').innerHTML = `
            <tr><td colspan="7" class="text-center text-danger py-4">Error: ${msg}</td></tr>
        `;
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
{% endblock %}