{% extends "layout.html" %}
{% block content %}
<div class="row">
    <!-- Header -->
    <div class="col-12 mb-4 d-flex justify-content-between align-items-center">
        <h2>
            <i class="bi bi-youtube text-danger me-2"></i> YouTube Channels
        </h2>
        <a href="/loopbot/auth?mode=add" class="btn btn-primary">
            <i class="bi bi-plus-lg me-1"></i> Add Channel
        </a>
    </div>

    <!-- Channel List -->
    <div class="col-12">
        <div class="card bg-dark border-secondary">
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-dark table-hover mb-0 align-middle">
                        <thead>
                            <tr class="bg-secondary bg-opacity-10">
                                <th style="width: 80px;">Profile</th>
                                <th>Channel Name</th>
                                <th>Subscribers</th>
                                <th>Total Views</th>
                                <th>Videos</th>
                                <th style="width: 150px;">Status</th>
                                <th style="width: 150px;" class="text-end">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="channelListBody">
                            <!-- Populated by JS -->
                            <tr id="loadingRow">
                                <td colspan="7" class="text-center py-5">
                                    <div class="spinner-border text-primary" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <p class="text-secondary mt-2">Loading channels...</p>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content bg-dark border-secondary">
            <div class="modal-header border-secondary">
                <h5 class="modal-title">Remove Channel</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove <strong id="deleteChannelName" class="text-light"></strong>?</p>
                <p class="text-secondary small">This will remove the credentials from LoopBot. You will need to login
                    again to use this channel.</p>
            </div>
            <div class="modal-footer border-secondary">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" onclick="confirmDelete()">Remove</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentChannels = [];
    let deleteId = null;

    document.addEventListener('DOMContentLoaded', loadChannels);

    function loadChannels() {
        fetch('/loopbot/channels/list')
            .then(r => r.json())
            .then(data => {
                if (data.success) {
                    currentChannels = data.channels;
                    renderChannels();
                } else {
                    showError(data.message);
                }
            })
            .catch(err => showError(err.message));
    }

    function renderChannels() {
        const tbody = document.getElementById('channelListBody');

        if (currentChannels.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="text-center py-5 text-secondary">
                        <i class="bi bi-person-x fs-1 mb-3 d-block"></i>
                        No channels connected. Click "Add Channel" to connect your YouTube account.
                    </td>
                </tr>
            `;
            return;
        }

        tbody.innerHTML = currentChannels.map(c => `
            <tr class="${c.active ? 'table-active border-start border-primary border-4' : ''}">
                <td>
                    <img src="${c.thumbnail}" alt="Thumb" class="rounded-circle" width="50" height="50">
                </td>
                <td>
                    <div class="fw-bold fs-5">${c.title}</div>
                    <small class="text-secondary text-monospace">${c.id}</small>
                </td>
                <td>${parseInt(c.subscriberCount).toLocaleString()}</td>
                <td>${parseInt(c.viewCount).toLocaleString()}</td>
                <td>${parseInt(c.videoCount).toLocaleString()}</td>
                <td>
                    ${c.active
                ? '<span class="badge bg-success"><i class="bi bi-check-circle me-1"></i> Active</span>'
                : `<button class="btn btn-sm btn-outline-primary" onclick="switchChannel('${c.id}')">Switch to this</button>`
            }
                </td>
                <td class="text-end">
                    <button class="btn btn-sm btn-outline-danger" onclick="promptDelete('${c.id}', '${escapeHtml(c.title)}')">
                        <i class="bi bi-trash"></i>
                    </button>
                </td>
            </tr>
        `).join('');
    }

    function switchChannel(id) {
        if (!confirm('Switch active channel to this one?')) return;

        fetch(`/loopbot/channels/switch/${id}`, { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    // Reload to update UI
                    window.location.reload();
                } else {
                    alert('Failed to switch: ' + d.message);
                }
            });
    }

    function promptDelete(id, name) {
        deleteId = id;
        document.getElementById('deleteChannelName').textContent = name;
        new bootstrap.Modal(document.getElementById('deleteModal')).show();
    }

    function confirmDelete() {
        if (!deleteId) return;

        fetch(`/loopbot/channels/delete/${deleteId}`, { method: 'POST' })
            .then(r => r.json())
            .then(d => {
                if (d.success) {
                    location.reload();
                } else {
                    alert(d.message);
                }
            });
    }

    function showError(msg) {
        document.getElementById('channelListBody').innerHTML = `
            <tr><td colspan="7" class="text-center text-danger py-4">Error: ${msg}</td></tr>
        `;
    }

    function escapeHtml(text) {
        if (!text) return '';
        return text.replace(/&/g, "&amp;")
            .replace(/</g, "&lt;")
            .replace(/>/g, "&gt;")
            .replace(/"/g, "&quot;")
            .replace(/'/g, "&#039;");
    }
</script>
{% endblock %}